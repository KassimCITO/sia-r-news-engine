{% extends "base.html" %}

{% block title %}Ejecutar Pipeline - SIA-R{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <a href="/dashboard" class="btn btn-secondary mb-3">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
        <h1><i class="bi bi-play-circle"></i> Ejecutar Pipeline</h1>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Configuración de Ejecución</h5>
            </div>
            <div class="card-body">
                <div id="selected-trend-banner" class="mb-3" style="display:none;">
                    <div class="alert alert-info d-flex justify-content-between align-items-center mb-0">
                        <div id="selected-trend-text">Tendencia seleccionada</div>
                        <div>
                            <button class="btn btn-sm btn-outline-light me-2" id="clear-trend-btn">Borrar</button>
                        </div>
                    </div>
                </div>
                <!-- Trends for quick prefill -->
                <div class="mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Tendencias (Google Trends)</h6>
                        </div>
                        <div class="card-body" id="pipeline-trends-list">
                            <div class="text-muted">Cargando tendencias...</div>
                        </div>
                    </div>
                </div>
                <form id="pipeline-form" onsubmit="runPipeline(event)">
                    <!-- Title -->
                    <div class="mb-3">
                        <label for="article-title" class="form-label">Título del Artículo</label>
                        <input type="text" class="form-control" id="article-title" required
                            placeholder="Ej: Las nuevas tendencias en IA">
                    </div>

                    <!-- Content -->
                    <div class="mb-3">
                        <label for="article-content" class="form-label">Contenido</label>
                        <textarea class="form-control" id="article-content" rows="8" required
                            placeholder="Ingresa el contenido del artículo aquí..."></textarea>
                    </div>

                    <!-- Author -->
                    <div class="mb-3">
                        <label for="article-author" class="form-label">Autor</label>
                        <input type="text" class="form-control" id="article-author" placeholder="Nombre del autor">
                    </div>

                    <!-- URL Source -->
                    <div class="mb-3">
                        <label for="article-url" class="form-label">URL Fuente (opcional)</label>
                        <input type="url" class="form-control" id="article-url" placeholder="https://...">
                    </div>

                    <!-- Category -->
                    <div class="mb-3">
                        <label for="article-category" class="form-label">Categoría</label>
                        <select class="form-select" id="article-category">
                            <option value="">Detectar automáticamente</option>
                            <option value="Tecnología">Tecnología</option>
                            <option value="Política">Política</option>
                            <option value="Economía">Economía</option>
                            <option value="Deportes">Deportes</option>
                            <option value="Salud">Salud</option>
                        </select>
                    </div>

                    <!-- Options -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="skip-cleaner">
                                <label class="form-check-label" for="skip-cleaner">
                                    Saltar limpieza
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="skip-humanizer">
                                <label class="form-check-label" for="skip-humanizer">
                                    Saltar humanización
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Execute Button -->
                    <button type="submit" class="btn btn-primary btn-lg w-100" id="execute-btn">
                        <i class="bi bi-play-fill"></i> Ejecutar Pipeline
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar: Info -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Etapas del Pipeline</h5>
            </div>
            <div class="card-body">
                <ol class="small">
                    <li>Limpieza y normalización</li>
                    <li>Extracción de categorías</li>
                    <li>Auditoría de calidad</li>
                    <li>Verificación de datos</li>
                    <li>Humanización de texto</li>
                    <li>Optimización SEO</li>
                    <li>Planificación de publicación</li>
                    <li>Generación de reportes</li>
                </ol>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Requisitos Mínimos</h5>
            </div>
            <div class="card-body">
                <ul class="small list-unstyled">
                    <li><i class="bi bi-check-circle-fill text-success"></i> Título: 5+ caracteres</li>
                    <li><i class="bi bi-check-circle-fill text-success"></i> Contenido: 50+ palabras</li>
                    <li><i class="bi bi-check-circle-fill text-success"></i> API Key válida</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resultados de Ejecución</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="results-content">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Procesando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="savePipeline()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    let lastPipelineResult = null;

    function runPipeline(event) {
        event.preventDefault();

        const title = document.getElementById('article-title').value;
        const content = document.getElementById('article-content').value;
        const author = document.getElementById('article-author').value || 'Anónimo';
        const url = document.getElementById('article-url').value;
        const category = document.getElementById('article-category').value;

        // Basic validation
        if (title.length < 5) {
            alert('El título debe tener al menos 5 caracteres');
            return;
        }

        if (content.length < 50) {
            alert('El contenido debe tener al menos 50 palabras');
            return;
        }

        // Disable button
        const btn = document.getElementById('execute-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2"></span> Ejecutando...';

        const payload = {
            title,
            content,
            author,
            url: url || null,
            category: category || null
        };

        fetch('/api/pipeline/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(data => {
                lastPipelineResult = data;
                displayResults(data);
                new bootstrap.Modal(document.getElementById('resultsModal')).show();
            })
            .catch(error => {
                alert('Error: ' + error.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-fill"></i> Ejecutar Pipeline';
            });
    }

    function displayResults(result) {
        // Backend returns { status: 'success', final_text, final_h1, final_meta_description,
        // final_categories, final_tags, quality_score, warnings }
        if (!result || result.status !== 'success') {
            document.getElementById('results-content').innerHTML = `
            <div class="alert alert-danger">
                <h6>Error en ejecución</h6>
                <p>${(result && (result.error || result.message)) || 'Error desconocido'}</p>
            </div>
        `;
            return;
        }

        const qualityPercent = typeof result.quality_score === 'number' ? (result.quality_score * 100).toFixed(1) + '%' : 'N/A';
        const factRisk = (result.stages && result.stages.fact_checker && typeof result.stages.fact_checker.risk_score === 'number') ? (result.stages.fact_checker.risk_score * 100).toFixed(1) + '%' : 'N/A';
        const categories = result.final_categories || result.stages?.taxonomy?.categories || [];
        const tags = result.final_tags || result.stages?.taxonomy?.tags || [];
        const processed = result.final_text || result.processed_content || '';

        const html = `
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-body">
                        <h6>Puntuación de Calidad</h6>
                        <h4>${qualityPercent}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-body">
                        <h6>Riesgo de Factualidad</h6>
                        <h4>${factRisk}</h4>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Categorías Detectadas</h6>
            </div>
            <div class="card-body">
                <div id="categories">${categories.map(c => `<span class="badge bg-info me-1">${c}</span>`).join(' ')}</div>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Tags Generados</h6>
            </div>
            <div class="card-body">
                <div id="tags">${tags.map(t => `<span class="badge bg-secondary me-1">${t}</span>`).join(' ')}</div>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Contenido Procesado</h6>
            </div>
            <div class="card-body">
                <p>${processed.substring(0, 300)}${processed.length > 300 ? '...' : ''}</p>
            </div>
        </div>
    `;

        document.getElementById('results-content').innerHTML = html;
    }

    function savePipeline() {
        if (!lastPipelineResult) return;

        // Save to localStorage for later review
        localStorage.setItem('last_pipeline_result', JSON.stringify(lastPipelineResult));
        alert('Resultado guardado. Puedes revisarlo en el panel de control.');
        window.location.href = '/dashboard';
    }

    function getToken() {
        return localStorage.getItem('auth_token') || '';
    }

    // Prefill fields if a selected trend exists in localStorage
    document.addEventListener('DOMContentLoaded', function () {
        try {
            const sel = localStorage.getItem('selected_trend');
            if (!sel) return;

            const trend = JSON.parse(sel);
            if (!trend) return;

            // Prefill title and content fields
            const titleEl = document.getElementById('article-title');
            const contentEl = document.getElementById('article-content');
            const categoryEl = document.getElementById('article-category');

            if (titleEl && !titleEl.value) titleEl.value = trend.title || '';
            if (contentEl && !contentEl.value) {
                // Use summary as starter content; keep editable
                contentEl.value = (trend.summary ? trend.summary + "\n\nFuente: " + (trend.source || '') : '') || '';
            }
            if (categoryEl && trend.category) {
                const opt = Array.from(categoryEl.options).find(o => o.value === trend.category);
                if (opt) categoryEl.value = trend.category;
            }

            // Show banner
            const banner = document.getElementById('selected-trend-banner');
            const bannerText = document.getElementById('selected-trend-text');
            const clearBtn = document.getElementById('clear-trend-btn');
            if (banner && bannerText) {
                bannerText.textContent = `Tendencia precargada: ${trend.title} (${trend.source})`;
                banner.style.display = 'block';
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', function () {
                    localStorage.removeItem('selected_trend');
                    if (banner) banner.style.display = 'none';
                    showToast('Selección eliminada', 'info');
                });
            }

        } catch (err) {
            console.error('Error prefilling pipeline from trend', err);
        }

        // Load categories from settings
        loadPipelineCategories();

        // Load live trends into the pipeline side list (non-blocking)
        if (typeof loadTrendsForPipeline === 'function') {
            loadTrendsForPipeline(10);
        }
    });

    /**
     * Load categories from settings and populate the category dropdown
     */
    function loadPipelineCategories() {
        fetch('/api/ui/settings', {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success' && data.settings && data.settings.wp_categories) {
                    const categorySelect = document.getElementById('article-category');
                    if (!categorySelect) return;

                    const categories = data.settings.wp_categories;

                    // Keep the "auto-detect" option
                    categorySelect.innerHTML = '<option value="">Detectar automáticamente</option>';

                    // Add categories from settings
                    if (Array.isArray(categories) && categories.length > 0) {
                        categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat;
                            option.textContent = cat;
                            categorySelect.appendChild(option);
                        });
                    } else {
                        // Fallback to default categories if none configured
                        const defaultCategories = ['Tecnología', 'Política', 'Economía', 'Deportes', 'Salud'];
                        defaultCategories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat;
                            option.textContent = cat;
                            categorySelect.appendChild(option);
                        });
                    }
                }
            })
            .catch(err => {
                console.error('Error loading categories:', err);
                // Keep default hardcoded options on error
            });
    }

    function getToken() {
        return localStorage.getItem('auth_token') || '';
    }

</script>
{% endblock %}