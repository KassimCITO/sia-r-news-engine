{% extends "base.html" %}

{% block title %}Artículos Publicados - SIA-R{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="bi bi-check2-circle"></i> Artículos Publicados</h1>
        <hr>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="search-input" 
                               placeholder="Buscar por título..." onkeyup="filterTable()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="category-filter" onchange="filterTable()">
                            <option value="">Todas las categorías</option>
                            <option value="Tecnología">Tecnología</option>
                            <option value="Política">Política</option>
                            <option value="Economía">Economía</option>
                            <option value="Deportes">Deportes</option>
                            <option value="Salud">Salud</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="sort-select" onchange="filterTable()">
                            <option value="date-desc">Más recientes primero</option>
                            <option value="date-asc">Más antiguos primero</option>
                            <option value="title-asc">Título A-Z</option>
                            <option value="title-desc">Título Z-A</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Articles Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Artículos en WordPress</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="articles-table">
                    <thead class="table-light">
                        <tr>
                            <th>Título</th>
                            <th>Categoría</th>
                            <th>Autor</th>
                            <th>Fecha Publicación</th>
                            <th>Vistas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="articles-body">
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="row mt-4">
    <div class="col-md-12 text-center">
        <nav>
            <ul class="pagination" id="pagination">
                <!-- Generated by JavaScript -->
            </ul>
        </nav>
    </div>
</div>

<!-- Article Detail Modal -->
<div class="modal fade" id="articleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">-</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="modal-content">Cargando...</p>
                <div class="row text-center mt-3">
                    <div class="col-md-6">
                        <p class="text-muted small">Categoría</p>
                        <h6 id="modal-category">-</h6>
                    </div>
                    <div class="col-md-6">
                        <p class="text-muted small">Fecha Publicación</p>
                        <h6 id="modal-date">-</h6>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a id="modal-link" href="#" class="btn btn-primary" target="_blank">
                    <i class="bi bi-box-arrow-up-right"></i> Ver en WordPress
                </a>
            </div>
        </div>
    </div>
</div>

<script>
let allArticles = [];
let currentPage = 1;
const itemsPerPage = 10;

document.addEventListener('DOMContentLoaded', function() {
    loadPublishedArticles();
});

function loadPublishedArticles() {
    fetch('/api/ui/published', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.articles) {
            allArticles = data.articles;
            displayArticles();
        }
    });
}

function displayArticles() {
    const filtered = filterArticles();
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginated = filtered.slice(start, end);
    
    const tbody = document.getElementById('articles-body');
    tbody.innerHTML = paginated.map(article => `
        <tr>
            <td>
                <strong style="cursor: pointer;" onclick="showArticleDetail('${article.id}')">
                    ${article.title}
                </strong>
            </td>
            <td><span class="badge bg-info">${article.category || 'Sin categoría'}</span></td>
            <td>${article.author || 'Anónimo'}</td>
            <td>${new Date(article.published_date).toLocaleDateString()}</td>
            <td><span class="badge bg-secondary">${article.views || 0}</span></td>
            <td>
                <a href="${article.url}" target="_blank" class="btn btn-sm btn-primary">
                    <i class="bi bi-box-arrow-up-right"></i>
                </a>
                <button class="btn btn-sm btn-danger" onclick="unpublishArticle('${article.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    // Update pagination
    const totalPages = Math.ceil(filtered.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
        pagination.appendChild(li);
    }
}

function filterArticles() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const category = document.getElementById('category-filter').value;
    const sort = document.getElementById('sort-select').value;
    
    let filtered = allArticles.filter(article => {
        const matchSearch = article.title.toLowerCase().includes(search);
        const matchCategory = !category || article.category === category;
        return matchSearch && matchCategory;
    });
    
    // Sort
    if (sort === 'date-asc') {
        filtered.sort((a, b) => new Date(a.published_date) - new Date(b.published_date));
    } else if (sort === 'date-desc') {
        filtered.sort((a, b) => new Date(b.published_date) - new Date(a.published_date));
    } else if (sort === 'title-asc') {
        filtered.sort((a, b) => a.title.localeCompare(b.title));
    } else if (sort === 'title-desc') {
        filtered.sort((a, b) => b.title.localeCompare(a.title));
    }
    
    return filtered;
}

function filterTable() {
    currentPage = 1;
    displayArticles();
}

function goToPage(page) {
    currentPage = page;
    displayArticles();
    window.scrollTo(0, 0);
}

function showArticleDetail(articleId) {
    const article = allArticles.find(a => a.id === articleId);
    if (!article) return;
    
    document.getElementById('modal-title').textContent = article.title;
    document.getElementById('modal-content').textContent = article.content.substring(0, 500) + '...';
    document.getElementById('modal-category').textContent = article.category || 'Sin categoría';
    document.getElementById('modal-date').textContent = new Date(article.published_date).toLocaleDateString();
    document.getElementById('modal-link').href = article.url;
    
    new bootstrap.Modal(document.getElementById('articleModal')).show();
}

function unpublishArticle(articleId) {
    if (!confirm('¿Estás seguro de que deseas desapublicar este artículo?')) return;
    
    fetch(`/api/wp/post/${articleId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Artículo desapublicado');
            loadPublishedArticles();
        }
    });
}

function getToken() {
    return localStorage.getItem('auth_token') || '';
}
</script>
{% endblock %}
