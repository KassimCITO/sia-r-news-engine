{% extends "base.html" %}

{% block title %}Logs de Ejecución - SIA-R{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="bi bi-file-text"></i> Logs de Ejecución</h1>
        <p class="text-muted">Historial de procesamiento del pipeline</p>
        <hr>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="search-input" 
                               placeholder="Buscar por artículo..." onkeyup="filterLogs()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="status-filter" onchange="filterLogs()">
                            <option value="">Todos los estados</option>
                            <option value="success">Exitoso</option>
                            <option value="failed">Fallido</option>
                            <option value="pending">Pendiente</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="date-filter" onchange="filterLogs()">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-secondary w-100" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logs Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="logs-table">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>Artículo</th>
                            <th>Estado</th>
                            <th>Tiempo (ms)</th>
                            <th>Calidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body">
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="row mt-4">
    <div class="col-md-12 text-center">
        <nav>
            <ul class="pagination" id="pagination">
                <!-- Generated by JavaScript -->
            </ul>
        </nav>
    </div>
</div>

<!-- Log Detail Modal -->
<div class="modal fade" id="logModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="text-muted small">Artículo</p>
                        <h6 id="modal-article">-</h6>
                    </div>
                    <div class="col-md-6">
                        <p class="text-muted small">Fecha</p>
                        <h6 id="modal-date">-</h6>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <p class="text-muted small">Estado</p>
                        <h6><span id="modal-status" class="badge">-</span></h6>
                    </div>
                    <div class="col-md-4">
                        <p class="text-muted small">Tiempo Ejecución</p>
                        <h6 id="modal-time">-</h6>
                    </div>
                    <div class="col-md-4">
                        <p class="text-muted small">Calidad</p>
                        <h6 id="modal-quality">-</h6>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Mensaje/Error</h6>
                    </div>
                    <div class="card-body">
                        <p id="modal-message" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">-</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <p class="text-muted small">Etapas Completadas</p>
                        <div id="modal-stages">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="retryLog()">
                    <i class="bi bi-arrow-clockwise"></i> Reintentar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let allLogs = [];
let currentPage = 1;
const itemsPerPage = 15;
let currentLogId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
});

function loadLogs() {
    fetch('/api/ui/logs', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.logs) {
            allLogs = data.logs;
            displayLogs();
        }
    });
}

function displayLogs() {
    const filtered = filterLogsData();
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginated = filtered.slice(start, end);
    
    const tbody = document.getElementById('logs-body');
    tbody.innerHTML = paginated.map(log => `
        <tr>
            <td>${new Date(log.created_at).toLocaleString()}</td>
            <td>
                <span style="cursor: pointer;" onclick="showLogDetail('${log.id}')">
                    ${log.preview_text.substring(0, 30)}...
                </span>
            </td>
            <td>
                <span class="badge bg-${getStatusColor(log.status)}">
                    ${log.status}
                </span>
            </td>
            <td>${log.execution_time.toFixed(0)}</td>
            <td>
                <span class="badge bg-${getQualityColor(log.quality_score)}">
                    ${(log.quality_score * 100).toFixed(0)}%
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-info" onclick="showLogDetail('${log.id}')">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteLog('${log.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    // Update pagination
    const totalPages = Math.ceil(filtered.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
        pagination.appendChild(li);
    }
}

function filterLogsData() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const status = document.getElementById('status-filter').value;
    const date = document.getElementById('date-filter').value;
    
    return allLogs.filter(log => {
        const matchSearch = log.preview_text.toLowerCase().includes(search);
        const matchStatus = !status || log.status === status;
        const logDate = new Date(log.created_at).toISOString().split('T')[0];
        const matchDate = !date || logDate === date;
        
        return matchSearch && matchStatus && matchDate;
    }).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
}

function filterLogs() {
    currentPage = 1;
    displayLogs();
}

function goToPage(page) {
    currentPage = page;
    displayLogs();
    window.scrollTo(0, 0);
}

function showLogDetail(logId) {
    const log = allLogs.find(l => l.id === logId);
    if (!log) return;
    
    currentLogId = logId;
    document.getElementById('modal-article').textContent = log.preview_text.substring(0, 50);
    document.getElementById('modal-date').textContent = new Date(log.created_at).toLocaleString();
    document.getElementById('modal-status').textContent = log.status;
    document.getElementById('modal-status').className = 'badge bg-' + getStatusColor(log.status);
    document.getElementById('modal-time').textContent = log.execution_time.toFixed(2) + ' ms';
    document.getElementById('modal-quality').textContent = (log.quality_score * 100).toFixed(1) + '%';
    document.getElementById('modal-message').textContent = log.error_message || 'Procesamiento completado exitosamente';
    
    // Display stages
    const stages = log.completed_stages || [];
    const stagesHtml = stages.map(stage => `
        <span class="badge bg-success me-2 mb-2">${stage}</span>
    `).join('');
    document.getElementById('modal-stages').innerHTML = stagesHtml || '<span class="text-muted">Sin etapas completadas</span>';
    
    new bootstrap.Modal(document.getElementById('logModal')).show();
}

function deleteLog(logId) {
    if (!confirm('¿Estás seguro de que deseas eliminar este log?')) return;
    
    fetch(`/api/ui/logs/${logId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            loadLogs();
        }
    });
}

function clearLogs() {
    if (!confirm('¿Estás seguro? Se eliminarán TODOS los logs.')) return;
    
    fetch('/api/ui/logs/clear', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Logs eliminados');
            loadLogs();
        }
    });
}

function retryLog() {
    alert('Reintentando procesamiento...');
    new bootstrap.Modal(document.getElementById('logModal')).hide();
}

function getStatusColor(status) {
    if (status === 'success') return 'success';
    if (status === 'failed') return 'danger';
    if (status === 'pending') return 'warning';
    return 'secondary';
}

function getQualityColor(score) {
    if (score >= 0.85) return 'success';
    if (score >= 0.70) return 'info';
    if (score >= 0.50) return 'warning';
    return 'danger';
}

function getToken() {
    return localStorage.getItem('auth_token') || '';
}
</script>
{% endblock %}
