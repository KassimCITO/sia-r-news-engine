{% extends "base.html" %}

{% block title %}Dashboard - SIA-R{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
        <hr>
    </div>
</div>

<!-- Stats Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title">Artículos Procesados</h6>
                <h2 id="total-articles">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">Tasa Éxito</h6>
                <h2 id="success-rate">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h6 class="card-title">En Revisión</h6>
                <h2 id="pending-count">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">Publicados</h6>
                <h2 id="published-count">-</h2>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Acciones Rápidas</h5>
            </div>
            <div class="card-body">
                <a href="/pipeline/run" class="btn btn-primary">
                    <i class="bi bi-play-circle"></i> Ejecutar Pipeline
                </a>
                <a href="/dashboard?tab=pending" class="btn btn-warning">
                    <i class="bi bi-clock"></i> Ver en Revisión
                </a>
                <a href="/published" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Ver Publicados
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Panel -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-sliders"></i> Configuración Rápida</h5>
                <button class="btn btn-sm btn-light text-primary" onclick="saveDashboardSettings()">
                    <i class="bi bi-save"></i> Guardar Cambios
                </button>
            </div>
            <div class="card-body">
                <form id="dashboardSettingsForm">
                    <div class="row">
                        <!-- Keywords -->
                        <div class="col-md-6 mb-3">
                            <label for="trend_keywords" class="form-label fw-bold">Palabras Clave (Tendencias)</label>
                            <textarea class="form-control" name="trend_keywords" id="trend_keywords" rows="4"
                                placeholder="noticias mexico, inteligencia artificial, economia..."></textarea>
                            <div class="form-text">Separa las palabras clave con comas. Esto alimenta el buscador de
                                tendencias.</div>
                        </div>

                        <!-- WP Config -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="site_url" class="form-label fw-bold">WordPress URL</label>
                                <div class="input-group">
                                    <input type="url" class="form-control" name="site_url" id="site_url"
                                        placeholder="https://misitio.com">
                                    <button class="btn btn-outline-secondary" type="button"
                                        onclick="loadWpCategories()">
                                        <i class="bi bi-arrow-repeat"></i> Cargar Cats
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="wp_categories" class="form-label fw-bold">Categorías Seleccionadas</label>
                                <select multiple class="form-select" name="wp_categories" id="wp_categories"
                                    style="height: 100px;">
                                    <!-- Options populated via JS -->
                                </select>
                                <div class="form-text">Selecciona las categorías donde publicar. Ctrl+Click para
                                    múltiples.</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Trends Grid -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Tendencias Actuales</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <small class="text-muted">Eventos detectados por Google Trends y fuentes sociales</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="loadTrendsRefresh();">Actualizar</button>
                    </div>
                </div>
                <div id="trends-grid" class="trends-grid">
                    <!-- Trend cards will be injected here -->
                    <div class="text-center text-muted w-100 py-4">
                        <i class="bi bi-hourglass-split"></i> Cargando tendencias...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Items Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Artículos Recientes en Revisión</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="articles-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Vista Previa</th>
                                <th>Calidad</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="articles-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> Cargando...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadDashboardStats();
        loadRecentArticles();
        // Load trends section
        if (typeof loadTrends === 'function') loadTrends();

        // Load Settings
        loadDashboardSettings();
    });

    function loadDashboardSettings() {
        fetch('/api/ui/settings', {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    const s = data.settings;
                    if (document.getElementById('trend_keywords'))
                        document.getElementById('trend_keywords').value = s.trend_keywords || '';
                    if (document.getElementById('site_url'))
                        document.getElementById('site_url').value = s.wp_url || '';

                    // If WP URL exists, try to load categories
                    if (s.wp_url) {
                        loadWpCategories(s.wp_categories);
                    }
                }
            });
    }

    function saveDashboardSettings() {
        const data = {
            trend_keywords: document.getElementById('trend_keywords').value,
            site_url: document.getElementById('site_url').value,
            wp_categories: Array.from(document.getElementById('wp_categories').selectedOptions).map(o => o.value)
        };

        fetch('/api/ui/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            },
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(res => {
                if (res.status === 'success') {
                    alert('Configuración guardada correctamente');
                    if (typeof loadTrends === 'function') loadTrends(true); // force refresh
                } else {
                    alert('Error al guardar: ' + (res.message || res.error));
                }
            })
            .catch(err => alert('Error de red: ' + err));
    }

    function loadWpCategories(selectedIds = []) {
        const url = document.getElementById('site_url').value;
        if (!url) return;

        const select = document.getElementById('wp_categories');
        select.innerHTML = '<option>Cargando...</option>';

        fetch(`${url}/wp-json/wp/v2/categories?per_page=100`)
            .then(r => {
                if (!r.ok) throw new Error('Error fetching WP categories');
                return r.json();
            })
            .then(cats => {
                select.innerHTML = '';
                cats.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.textContent = c.name;
                    if (selectedIds.includes(c.name)) opt.selected = true;
                    select.appendChild(opt);
                });
            })
            .catch(e => {
                console.error(e);
                select.innerHTML = '<option value="">Error al cargar (Verifique CORS/URL)</option>';
            });
    }

    function loadDashboardStats() {
        fetch('/api/ui/status', {
            headers: {
                'Authorization': 'Bearer ' + getToken()
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.stats) {
                    document.getElementById('total-articles').textContent = data.stats.total_runs || 0;
                    document.getElementById('success-rate').textContent =
                        (data.stats.success_rate * 100).toFixed(1) + '%' || '0%';
                    document.getElementById('pending-count').textContent = data.pending_reviews || 0;
                }
            });
    }

    function loadRecentArticles() {
        fetch('/api/ui/reviews?status=pending&limit=10', {
            headers: {
                'Authorization': 'Bearer ' + getToken()
            }
        })
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('articles-body');
                tbody.innerHTML = '';

                if (data.reviews && data.reviews.length > 0) {
                    data.reviews.forEach(review => {
                        const row = `
                    <tr>
                        <td>${review.id}</td>
                        <td>${review.preview_text}</td>
                        <td>
                            <span class="badge bg-${getQualityBadge(review.quality_score)}">
                                ${(review.quality_score * 100).toFixed(0)}%
                            </span>
                        </td>
                        <td><span class="badge bg-warning">En Revisión</span></td>
                        <td>${new Date(review.created_at).toLocaleDateString()}</td>
                        <td>
                            <a href="/review/view/${review.id}" class="btn btn-sm btn-primary">Ver</a>
                        </td>
                    </tr>
                `;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay artículos en revisión</td></tr>';
                }
            });
    }

    function getQualityBadge(score) {
        if (score >= 0.85) return 'success';
        if (score >= 0.70) return 'info';
        if (score >= 0.50) return 'warning';
        return 'danger';
    }

    function getToken() {
        return localStorage.getItem('auth_token') || '';
    }
</script>
{% endblock %}