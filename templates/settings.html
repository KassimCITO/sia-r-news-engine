{% extends "base.html" %}

{% block title %}Configuración - SIA-R{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="bi bi-gear"></i> Configuración</h1>
        <p class="text-muted">Gestiona la configuración del sistema y las reglas de auto-publicación</p>
        <hr>
    </div>
</div>

<div class="row">
    <!-- Navigation Tabs -->
    <div class="col-md-3">
        <div class="list-group" role="tablist">
            <button class="list-group-item list-group-item-action active" id="tab-autopublish" 
                    data-bs-toggle="list" href="#autopublish" role="tab">
                <i class="bi bi-robot"></i> Auto-publicación
            </button>
            <button class="list-group-item list-group-item-action" id="tab-roles"
                    data-bs-toggle="list" href="#roles" role="tab">
                <i class="bi bi-shield-lock"></i> Permisos & Roles
            </button>
            <button class="list-group-item list-group-item-action" id="tab-notifications"
                    data-bs-toggle="list" href="#notifications" role="tab">
                <i class="bi bi-bell"></i> Notificaciones
            </button>
            <button class="list-group-item list-group-item-action" id="tab-integrations"
                    data-bs-toggle="list" href="#integrations" role="tab">
                <i class="bi bi-link-45deg"></i> Integraciones
            </button>
        </div>
    </div>

    <!-- Content -->
    <div class="col-md-9">
        <div class="tab-content">
            <!-- Auto-publish Settings -->
            <div class="tab-pane fade show active" id="autopublish" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Configuración de Auto-publicación</h5>
                    </div>
                    <div class="card-body">
                        <form id="autopublish-form">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enable-autopublish">
                                <label class="form-check-label" for="enable-autopublish">
                                    <strong>Activar auto-publicación</strong>
                                    <p class="small text-muted">Los artículos que cumplan los criterios se publicarán automáticamente</p>
                                </label>
                            </div>

                            <hr>

                            <h6>Criterios de Calidad</h6>

                            <div class="mb-3">
                                <label for="quality-threshold" class="form-label">
                                    Puntuación mínima de calidad: <strong id="quality-value">75</strong>%
                                </label>
                                <input type="range" class="form-range" id="quality-threshold" 
                                       min="0" max="100" value="75" oninput="updateValue('quality')">
                            </div>

                            <div class="mb-3">
                                <label for="risk-threshold" class="form-label">
                                    Puntuación máxima de riesgo: <strong id="risk-value">30</strong>%
                                </label>
                                <input type="range" class="form-range" id="risk-threshold" 
                                       min="0" max="100" value="30" oninput="updateValue('risk')">
                            </div>

                            <div class="mb-3">
                                <label for="seo-threshold" class="form-label">
                                    Puntuación mínima SEO: <strong id="seo-value">60</strong>%
                                </label>
                                <input type="range" class="form-range" id="seo-threshold" 
                                       min="0" max="100" value="60" oninput="updateValue('seo')">
                            </div>

                            <hr>

                            <h6>Categorías Permitidas</h6>
                            <p class="small text-muted mb-2">Solo estas categorías serán auto-publicadas</p>

                            <div id="categories-check">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="cat-tech" checked>
                                    <label class="form-check-label" for="cat-tech">Tecnología</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="cat-politics">
                                    <label class="form-check-label" for="cat-politics">Política</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="cat-economy" checked>
                                    <label class="form-check-label" for="cat-economy">Economía</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="cat-sports" checked>
                                    <label class="form-check-label" for="cat-sports">Deportes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="cat-health" checked>
                                    <label class="form-check-label" for="cat-health">Salud</label>
                                </div>
                            </div>

                            <hr>

                            <button type="button" class="btn btn-primary" onclick="saveSettings()">
                                <i class="bi bi-check-circle"></i> Guardar Configuración
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Roles & Permissions -->
            <div class="tab-pane fade" id="roles" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Permisos y Roles</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Rol</th>
                                        <th>Ver Panel</th>
                                        <th>Revisar</th>
                                        <th>Publicar</th>
                                        <th>Configurar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Editor</strong></td>
                                        <td><i class="bi bi-check-circle-fill text-success"></i></td>
                                        <td><i class="bi bi-check-circle-fill text-success"></i></td>
                                        <td><i class="bi bi-x-circle-fill text-danger"></i></td>
                                        <td><i class="bi bi-x-circle-fill text-danger"></i></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Publicador</strong></td>
                                        <td><i class="bi bi-check-circle-fill text-success"></i></td>
                                        <td><i class="bi bi-check-circle-fill text-success"></i></td>
                                        <td><i class="bi bi-check-circle-fill text-success"></i></td>
                                        <td><i class="bi bi-x-circle-fill text-danger"></i></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Administrador</strong></td>
                                        <td><i class="bi bi-check-circle-fill text-success"></i></td>
                                        <td><i class="bi bi-check-circle-fill text-success"></i></td>
                                        <td><i class="bi bi-check-circle-fill text-success"></i></td>
                                        <td><i class="bi bi-check-circle-fill text-success"></i></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="small text-muted mt-3">
                            Los permisos son asignados automáticamente según el rol de usuario en WordPress.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="tab-pane fade" id="notifications" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Configuración de Notificaciones</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notify-on-complete" checked>
                            <label class="form-check-label" for="notify-on-complete">
                                Notificar cuando termina el procesamiento
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notify-on-error" checked>
                            <label class="form-check-label" for="notify-on-error">
                                Notificar en caso de error
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notify-on-publish" checked>
                            <label class="form-check-label" for="notify-on-publish">
                                Notificar cuando se publica automáticamente
                            </label>
                        </div>

                        <hr>

                        <h6>Email para notificaciones</h6>
                        <input type="email" class="form-control" id="notification-email" 
                               placeholder="admin@ejemplo.com">

                        <button type="button" class="btn btn-primary mt-3" onclick="saveNotifications()">
                            <i class="bi bi-check-circle"></i> Guardar Notificaciones
                        </button>
                    </div>
                </div>
            </div>

            <!-- Integrations -->
            <div class="tab-pane fade" id="integrations" role="tabpanel">
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">WordPress</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Conecta con tu sitio WordPress</p>
                        <div class="mb-3">
                            <label for="wp-url" class="form-label">URL de WordPress</label>
                            <input type="url" class="form-control" id="wp-url" 
                                   placeholder="https://tusite.com">
                        </div>
                        <div class="mb-3">
                            <label for="wp-token" class="form-label">Token de autenticación</label>
                            <input type="password" class="form-control" id="wp-token" 
                                   placeholder="Tu token de aplicación">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="testWPConnection()">
                            <i class="bi bi-plug"></i> Probar Conexión
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">OpenAI API</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Configura tu clave de API de OpenAI</p>
                        <div class="mb-3">
                            <label for="openai-key" class="form-label">Clave de API</label>
                            <input type="password" class="form-control" id="openai-key" 
                                   placeholder="sk-...">
                            <small class="text-muted">Tu clave no se almacenará en la base de datos</small>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="testOpenAIConnection()">
                            <i class="bi bi-plug"></i> Probar Conexión
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
});

function updateValue(type) {
    if (type === 'quality') {
        document.getElementById('quality-value').textContent = document.getElementById('quality-threshold').value;
    } else if (type === 'risk') {
        document.getElementById('risk-value').textContent = document.getElementById('risk-threshold').value;
    } else if (type === 'seo') {
        document.getElementById('seo-value').textContent = document.getElementById('seo-threshold').value;
    }
}

function loadSettings() {
    fetch('/api/ui/settings', {
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.settings) {
            const settings = data.settings;
            document.getElementById('enable-autopublish').checked = settings.auto_publish_enabled || false;
            document.getElementById('quality-threshold').value = settings.quality_threshold || 75;
            document.getElementById('risk-threshold').value = settings.risk_threshold || 30;
            document.getElementById('seo-threshold').value = settings.seo_threshold || 60;
            
            updateValue('quality');
            updateValue('risk');
            updateValue('seo');
        }
    });
}

function saveSettings() {
    const settings = {
        auto_publish_enabled: document.getElementById('enable-autopublish').checked,
        quality_threshold: parseInt(document.getElementById('quality-threshold').value),
        risk_threshold: parseInt(document.getElementById('risk-threshold').value),
        seo_threshold: parseInt(document.getElementById('seo-threshold').value),
        allowed_categories: [
            document.getElementById('cat-tech').checked ? 'Tecnología' : null,
            document.getElementById('cat-politics').checked ? 'Política' : null,
            document.getElementById('cat-economy').checked ? 'Economía' : null,
            document.getElementById('cat-sports').checked ? 'Deportes' : null,
            document.getElementById('cat-health').checked ? 'Salud' : null
        ].filter(Boolean)
    };
    
    fetch('/api/ui/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify(settings)
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Configuración guardada correctamente');
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function saveNotifications() {
    const email = document.getElementById('notification-email').value;
    alert('Notificaciones guardadas: ' + email);
}

function testWPConnection() {
    const wpUrl = document.getElementById('wp-url').value.trim();
    const wpToken = document.getElementById('wp-token').value.trim();
    
    if (!wpUrl || !wpToken) {
        showToast('Error', 'Por favor completa URL y token', 'error');
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Probando...';
    
    fetch('/api/ui/test/wordpress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({
            url: wpUrl,
            token: wpToken
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Éxito', `✓ ${data.message}\nSitio: ${data.site_info.title}`, 'success');
        } else {
            showToast('Error', `✗ ${data.message}`, 'error');
        }
    })
    .catch(err => {
        showToast('Error', `✗ Error de conexión: ${err.message}`, 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function testOpenAIConnection() {
    const openaiKey = document.getElementById('openai-key').value.trim();
    
    if (!openaiKey) {
        showToast('Error', 'Por favor ingresa tu clave de API', 'error');
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Probando...';
    
    fetch('/api/ui/test/openai', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({
            api_key: openaiKey
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Éxito', `✓ ${data.message}\nModelo: ${data.model}`, 'success');
        } else {
            showToast('Error', `✗ ${data.message}`, 'error');
        }
    })
    .catch(err => {
        showToast('Error', `✗ Error de conexión: ${err.message}`, 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function showToast(title, message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        `;
        document.body.appendChild(toastContainer);
    }
    
    // Determine colors based on type
    const colors = {
        success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
        error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
        info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
    };
    
    const color = colors[type] || colors.info;
    
    // Create toast element
    const toast = document.createElement('div');
    toast.style.cssText = `
        background-color: ${color.bg};
        border: 1px solid ${color.border};
        color: ${color.text};
        padding: 15px 20px;
        border-radius: 4px;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease-in-out;
        max-width: 400px;
    `;
    
    if (title) {
        toast.innerHTML = `<strong>${title}:</strong> ${message}`;
    } else {
        toast.innerHTML = message;
    }
    
    toastContainer.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in-out';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Add CSS animations if not present
if (!document.getElementById('toast-styles')) {
    const style = document.createElement('style');
    style.id = 'toast-styles';
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}

function getToken() {
    return localStorage.getItem('auth_token') || '';
}
</script>
{% endblock %}
